---
layout: post
title: "Introduction to EML in R"
date:   2015-12-28
authors: [Carl Boettiger, Leah A. Wasser]
contributors: []
dateCreated: 2015-12-28
lastModified: `r format(Sys.time(), "%Y-%m-%d")`
tags: [spatio-temporal, time-series, phenology]
mainTag: time-series
packagesLibraries: [eml]
category: 
description: "This lesson will walk through the basic purpose and structure of metadata stored
in EML (Ecological Metadata Language) format. We will work with an EML file created
for an atmospheric dataset by the Harvard Forest LTER, using the R/OpenSci EML
library for R."
code1: 
image:
  feature: NEONCarpentryHeader_2.png
  credit: A collaboration between the National Ecological Observatory Network (NEON) and Data Carpentry
  creditlink: http://www.neoninc.org
permalink: /R/EML
comments: false
---

{% include _toc.html %}

#About

This lesson will walk through the basic purpose and structure of metadata stored
in EML (Ecological Metadata Language) format. We will work with an EML file created
for an atmospheric dataset by the Harvard Forest LTER, using the R/OpenSci EML
library for `R`.

To begin, we will load the `EML`, `purrr` and `dplyr` libraries.

```{r install-EML-package, results="hide", warning=FALSE }
#install R EML tools
#library("devtools")
#install_github("ropensci/EML", build=FALSE, dependencies=c("DEPENDS", "IMPORTS"))
#devtools::install_github(c("hadley/purrr", "ropensci/EML"))


#call package
library("EML")
library("purrr")
library("dplyr")

#data location
#http://harvardforest.fas.harvard.edu:8080/exist/apps/datasets/showData.html?id=hf001
#table 4 http://harvardforest.fas.harvard.edu/data/p00/hf001/hf001-04-monthly-m.csv
```

Next, we will read in the LTER EML file - directly from the online URL using
`eml_read`. This file documents multiple data products that can be downloaded.
<a href="http://harvardforest.fas.harvard.edu:8080/exist/apps/datasets/showData.html?id=hf001" target="_blank">
Check out the Harvard Forest Data Archive Page for Fisher Meteorological Station
for more on this dataset and to download the archive files directly.</a>


```{r read-eml }
#import EML from Harvard Forest Met Data
eml_HARV <- eml_read("http://harvardforest.fas.harvard.edu/data/eml/hf001.xml")

#view size of object
object.size(eml_HARV)

#view the object class
class(eml_HARV)
```

The `eml_read` function creates an `EML` class object. This object can be accessed
using `slots` in R (`@`) rather than a typical subset `[]` approach.

##Getting Started

Before we go too much further, let's get some basic terms out of the way. In the 
context of `EML`, a file documents a `dataset`. This `dataset` may consist of one
or more files that are documented in the `EML` document. In the case of our 
tabular meteorology data, the structure of our `EML` file includes:

1. The **dataset**. A dataset may contain
one or more data tables associated with it that may contain different types of related
information. For this Harvard meteorological data, the data tables contain tower
measurements including precipitation and temperature, that are aggregated
at various time intervales (15 minute, daily, etc) and that date back to 2001.
2. The **data tables**. Data tables refer to the actual data that make up the dataset. 
For the Harvard Data, each data table contains a suite of meterological metrics 
including precipiation and temperature (and associated quality flags), that are 
aggregated at a particular time interval. (e.g. one data table contains monthly
average data, another contains 15 minute averaged data, etc)


#Explore Basic EML Properties

We can begin to explore the contents of our EML file and associated data that it
describes. Let's start at the dataset level. We can use `eml_get` to view the 
contact information for the dataset, the keywords and it's associated temporal
and spatial (if relevant) coverage.


```{r view-eml-content }
#view the contact name listed in the file
#this works well!
eml_get(eml_HARV,"contact")

#grab all keywords in the file
eml_get(eml_HARV,"keywords")

#figure out the extent & temporal coverage of the data
eml_get(eml_HARV,"coverage")

```

##Figure Out Geographic Coverage
Above we were able to access the geographic coverage. Let's plot that quickly on 
a map for reference. We can access this information using the slots, which are
accessed in `R` using the `@` sign. 

<i class="fa fa-star"></i> **Data Tip:**  To figure out the full slot string, 
in `RStudio` we can use Tab Complete! 
{: .notice }



```{r find-geographic-coverage }
#view geographic coverage
eml_HARV@dataset@coverage@geographicCoverage

```

##Identify & Map Data Location

Looking at the coverage for our data, there is only one unique x and y value. This 
suggests that our data were collected at one point location. We know this is a 
tower so a point makes sense. Let's grab the x and y coordinates and create a quick
context map. We will use `ggmap` to create our map.

**NOTE: if this were a rectangular extent we'd want the bounding BOX. this is important
if the data are for eample, raster format, in HDF5 or something. we need the extent
to properly geolocate and process the data.**

Nice cheatsheet
https://www.nceas.ucsb.edu/~frazier/RSpatialGuides/ggmap/ggmapCheatsheet.pdf

```{r map-location, warning=FALSE}
#
XCoord <- eml_HARV@dataset@coverage@geographicCoverage@boundingCoordinates@westBoundingCoordinate

YCoord <- eml_HARV@dataset@coverage@geographicCoverage@boundingCoordinates@northBoundingCoordinate


library(ggmap)
#map <- get_map(location='Harvard', maptype = "terrain")
map <- get_map(location='massachusetts', maptype = "toner", zoom =8)

#map <- get_map(location='massachusetts', maptype = "roadmap")

ggmap(map, extent=TRUE) +
  geom_point(aes(x=XCoord,y=YCoord), color="darkred",size=6, pch=18)

```

We now have identified and mapped the point location where our data were collected. 
We know the data are close enough to our study area to be useful.

Next, let's dig into the dataset structure to figure out what metrics that data 
contain.

##Accessing dataset structure using EML

To understand the data that are available for us to work with, let's first explore
the `dataset` structure as outline in our `EML` file. We can access key components
of the dataset metadata structure using slots which are accessed via the `@`.

For example `eml_HARV@dataset` will return the entire dataset metadata structure.
Let's view the description of abstract for the dataset.

```{r view-dataset-eml }

#view dataset abstract (description)
eml_HARV@dataset@abstract

```

# View description and name of each data table in file

Let's generate a clean list of all data tables and associated data table descriptions
described in our `EML` file. To access this information we will using the following 
syntax:

`eml_HARV@dataset`

* we will add `@dataTable`
* we can access each dataTable element using index values: `[[1]]`
* we can access the name of each dataTable using `@entityName`
* we can access the description of each dataTable using `@entityDescription`

Let's try this next!

**NOTE: rbind warning - what does that mean? **

```{r view-data-tables }


#we can view the data table name and description as follows
eml_HARV@dataset@dataTable[[1]]@entityName
eml_HARV@dataset@dataTable[[1]]@entityDescription

#create an object that just contains dataTable level attributes
all.tables <- eml_HARV@dataset@dataTable

#use purrrr to generate a data.frame that contains the attrName and Def for each column
dataTable.desc <- purrr::map_df(all.tables, 
              function(x) 
              data.frame(attribute = x@entityName, 
                        description = x@entityDescription))

#view table descriptions
dataTable.desc
#how many rows (data tables) are in the list?
nrow(dataTable.desc)

```

**NOTE: the above code is complex given the length of the slot calls. it would be 
VERY NICE to have a function to help the user along with quickly generating / accessing
data table attributes and descriptions.**


Sweet! We now know that are 11 total data tables in this dataset. From the descriptions,
we have a sense of the temporal coverage (date range) and associated temporal
scale (15 min average, daily average, monthly average, etc). This is a lot of 
information to get us going. 

The data table of most interest to us now, is hourly average, in metric units.
`hf001-08-hourly-m.csv`. Let's explore that particular table next.

#Data Table Metadata
Let's next explore the attributes of Data Table 8. We can explore it's name,
a description of the data, it's physical characteristics and it's identifier.

```{r data-table-attr }

#create an object that contains metadata for table 8 only
EML.hr.dataTable <- obj@dataset@dataTable[[8]]

#Check out the table's name - make sure it's the right table!
EML.hr.dataTable@entityName

#what information does this data table contain?
EML.hr.dataTable@entityDescription

#how is the text file delimited?
EML.hr.dataTable@physical

#view table id
EML.hr.dataTable@id

#this is the download URL for the file.
EML.hr.dataTable@physical@distribution@online@url
```


##View Data Table Fields (attributes)
We can access the attributes of a data table using similar syntax to the dataset 
access.

However: 

* Instead of using `entityName` we will use `attributeName`
* Instead of using `entityDescription` we will use `attributeDescription`

Let's explore the dataTable attributes

```{r view-15min-attr-list }
#get list of measurements for the 10th data table in the EML file
EML.hr.attr <- EML.hr.dataTable@attributeList@attribute
#the first column is the date field
EML.hr.attr[[1]]

#view the column name and description for the first column
EML.hr.attr[[1]]@attributeName
EML.hr.attr[[1]]@attributeDefinition
```


#View All Data Table Attributes 

We can create an automated list of all data table attributes and associated
descriptions as we did with our data set too. 

We will generate a summary of fields in our data table that includes:

1. The field names (metrics measured or columns) `attributeName`
2. The description of each field `attributeDefinition`

Let's do that next.

```{r view-monthly-attrs }
#list of all attribute description and metadata
#EML.15min.attr

# use a split-apply-combine approach to parse the attribute data
# and create a data.frame with only the attribute name and description

#dplyr approach
#do.call(rbind, 
#        lapply(EML.15min.attr, function(x) data.frame(column.name = x@attributeName, 
#                                             definition = x@attributeDefinition)))

#use purrrr to generate a data.frame that contains the attrName and Def for each column
EML.hr.attr.dt8 <- purrr::map_df(EML.hr.attr, 
              function(x) 
                data.frame(attribute = x@attributeName, 
                                     description = x@attributeDefinition))

EML.hr.attr.dt8
```

##Download Data Table

We've now successfully explored our data. From our data.frame generated above, we
can see that this data table contains air temperature and precipitation - two 
key drivers of phenology. Thus, let's go ahead and download the data.

**note** I'd like to directly download the 4th data table. Can I use `eml_get` to
accomplish this?


```{r download-data }

#tried to subset out the dataTable component of the eml obj
dat <- eml_get(obj@dataset@dataTable[[4]], "data.frame")

dat <- eml_get(EML.hr.dataTable@physical@distribution@online@url,
               "data.frame")

#in theory the code below should work but it throws a URL error
library(RCurl)
x <- getURL(EML.hr.dataTable@physical@distribution@online@url)
y <- read.csv(text = x)

#the url below does work, why can't R access it but my browser can?
url <- month.avg.desc@physical@distribution@online@url
getURL(url)

y
#x <- getURL("http://harvardforest.fas.harvard.edu/data/p00/hf001/hf001-04-monthly-m.csv")

#the url below works.
#http://harvardforest.fas.harvard.edu/data/p00/hf001/hf001-04-monthly-m.csv

```


#OTHER STUFF


We can determine how many data tables are described in this EML document. We can
also view a list of all data tables referenced in the EML document using:

`eml_get(obj,"csv_filepaths")`

**NOTE - THESE PATHS ARE NOT THE CORRECT PATHS TO THE DATA - what are they??**

```{r EML-Structure }
###THIS IS THE WRONG OUTPUT FOR SOME REASON??
#what are the names of those tables?
data.paths <- eml_get(obj,"csv_filepaths")
data.paths

data.paths[4]
```





